(()=>{"use strict";function t(t){return t.replace(/[ !"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~]/g,"\\$&")}function o(t){let o={};var e;o.hex=(e=t.text(),Array.from((new TextEncoder).encode(e)).map((t=>t.toString(16))).join("")),o.var="default";let n=t.attr("mathvariant");null!=n&&(o.var="normal"==n?"roman":n);let i=t.data("math-concept");return null!=i&&(o.concept=Number(i)),o}let e={limited_highlight:!1,show_definition:!1};$((function(){let t=$("#option-limited-highlight"),o=$("#option-show-definition");"true"==localStorage["option-limited-highlight"]?(t.prop("checked",!0),e.limited_highlight=!0):e.limited_highlight=!1,"true"==localStorage["option-show-definition"]?(o.prop("checked",!0),e.show_definition=!0):e.show_definition=!1,u(),t.on("click",(function(){$(this).prop("checked")?(localStorage["option-limited-highlight"]="true",e.limited_highlight=!0):(localStorage["option-limited-highlight"]="false",e.limited_highlight=!1),u()})),o.on("click",(function(){$(this).prop("checked")?(localStorage["option-show-definition"]="true",e.show_definition=!0):(localStorage["option-show-definition"]="false",e.show_definition=!1),u()}))})),$((function(){$(".sidebar-tab input.tab-title").each((function(){let t=this.id;"true"==localStorage[t]&&$(`#${t}`).prop("checked",!0),$(`#${t}`).on("change",(function(){$(this).prop("checked")?localStorage[t]=!0:localStorage[t]=!1}))}))}));let n={};$.ajax({url:"/mcdict.json",dataType:"json",async:!1,success:function(t){n=t}});let i=["#008b8b","#ff7f50","#ff4500","#2f4f4f","#006400","#dc143c","#c71585","#4169e1","#2e8b57","#ff1493","#191970","#ff69b4","#ff69b4","#0000cd","#f4a460","#ff00ff","#7cfc00","#d2691e","#a0522d","#800000","#9400d3","#556b2f","#4b0082","#808000"],l=0;for(let t in n)for(let o in n[t])for(let e in n[t][o])null!=n[t][o][e].description&&(n[t][o][e].color=i[l%i.length],l++);function a(t){return null!=t.concept?n[t.hex][t.var][t.concept]:void 0}function c(t){if(null!=n[t.hex])return n[t.hex][t.var]}function s(t){let e=a(o(t));null!=e&&null!=e.color&&t.attr("mathcolor",e.color)}$((function(){$("mi").each((function(){s($(this))}))}));let d={};function r(t,o,n){p(t);let i=a(o);var l;null==i||null==i.color?t.css("border-bottom","solid 2px #FF0000"):(t.css("background-color",`rgba(${(l=i.color,"#"==l.slice(0,1)&&(l=l.slice(1)),3==l.length&&(l=l.slice(0,1)+l.slice(0,1)+l.slice(1,2)+l.slice(1,2)+l.slice(2,3)+l.slice(2,3)),[l.slice(0,2),l.slice(2,4),l.slice(4,6)].map((function(t){return parseInt(t,16)}))).join()},0.3)`),e.show_definition&&1==n.type&&t.css("border-bottom","solid 3px")),t.attr({"data-sog-mi":n.mi_id,"data-sog-type":n.type,"data-sog-start":n.start_id,"data-sog-stop":n.stop_id})}function p(t){t.css("border-bottom",""),t.css("background-color","")}function u(){for(let n of d.sog){let i;if(n.start_id==n.stop_id)i=$("#"+t(n.start_id));else{let o=$("#"+t(n.start_id)),e=$("#"+t(n.stop_id));i=o.nextUntil("#"+t(n.stop_id)).addBack().add(e)}let l=o($("#"+t(n.mi_id)));if(e.limited_highlight&&null!=sessionStorage.mi_id){let e=o($("#"+t(sessionStorage.mi_id)));e.hex==l.hex&&e.var==l.var||p(i)}}for(let n of d.sog){let i;if(n.start_id==n.stop_id)i=$("#"+t(n.start_id));else{let o=$("#"+t(n.start_id)),e=$("#"+t(n.stop_id));i=o.nextUntil("#"+t(n.stop_id)).addBack().add(e)}let l=o($("#"+t(n.mi_id)));if(e.limited_highlight&&null!=sessionStorage.mi_id){let e=o($("#"+t(sessionStorage.mi_id)));e.hex==l.hex&&e.var==l.var&&r(i,l,n)}else r(i,l,n)}}$.ajax({url:"/sog.json",dataType:"json",async:!1,success:function(t){d=t}}),$((function(){$(document).tooltip({show:!1,hide:!1,items:"[data-math-concept]",content:function(){let t=a(o($(this)));if(null!=t){let o="NONE";return t.args_type.length>0&&(o=t.args_type.join(", ")),`${t.description} <span style="color: #808080;">[${o}] (arity: ${t.arity})</span>`}return"(No description)"},open:function(t,o){$("mi").each((function(){s($(this))}))}})})),$((function(){function i(e){e.attr("style","border: dotted 2px #000000; padding: 10px;");let i=o(e),a=c(i),d=e.attr("id");if(null!=a&&null!=d)if(a.length>0)!function(e,i,a){let c=`<input type="hidden" name="mi_id" value="${e}" />`,d="";for(let t in a){let o=a[t],n=`<input type="radio" name="concept" id="c${t}" value="${t}" ${Number(t)==i.concept?"checked":""} />`,l="NONE";o.args_type.length>0&&(l=o.args_type.join(", ")),d+=`${n}<span class="keep"><label for="c${t}">\n${o.description} <span style="color: #808080;">[${l}] (arity: ${o.arity})</span>\n(<a class="edit-concept" data-mi="${e}" data-concept="${t}" href="javascript:void(0);">edit</a>)\n</label></span>`}let r=`<p>ID: <span style="font-family: monospace;">${e}</span><hr color="#FFF"><form id="form-${e}" method="POST">${c+`<div class="keep">${d}</div><p><button id="assign-concept">Assign</button> <button id="remove-concept" type="button">Remove</button> <button id="new-concept" type="button">New</button></p>`}</form></p>`,p=$("#anno-box");p.html(r),$("button#assign-concept").button(),$("button#assign-concept").on("click",(function(){let o=p.find(`#form-${t(e)}`);if(!($(`#form-${t(e)} input:checked`).length>0))return alert("Please select a concept."),!1;localStorage.scroll_top=$(window).scrollTop(),o.attr("action","/_concept"),o.trigger("submit")})),$("button#remove-concept").button(),$("button#remove-concept").on("click",(function(){let o=p.find(`#form-${t(e)}`);o.attr("action","/_remove_concept"),o.trigger("submit")})),l(i),$("a.edit-concept").on("click",(function(){let e=$(this).attr("data-mi"),i=$(this).attr("data-concept");null!=e&&null!=i&&function(t,o){let e=$("#concept-dialog-template").clone();e.removeAttr("id");let i=e.find("#concept-form");i.attr("action","/_update_concept");let l=n[t.hex][t.var][o];i.find("textarea").text(l.description),i.find('input[name="arity"]').attr("value",l.arity),l.args_type.forEach((function(t,o){i.find(`select[name="args_type${o}"]`).find(`option[value="${t}"]`).prop("selected",!0)})),e.dialog({modal:!0,title:"Edit Concept",width:500,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),i.append(`<input type="hidden" name="idf_hex" value="${t.hex}" />`),i.append(`<input type="hidden" name="idf_var" value="${t.var}" />`),i.append(`<input type="hidden" name="concept_id" value="${o}" />`),i.trigger("submit")},Cancel:function(){$(this).dialog("close")}}})}(o($("#"+t(e))),Number(i))})),$("mi").each((function(){s($(this))}))}(d,i,a);else{let t=`<p>ID: <span style="font-family: monospace;">${d}</span><hr color="#FFF"><p>No concept is available.</p><p><button id="new-concept" type="button">New</button></p></p>`;$("#anno-box").html(t),l(i)}}function l(t){$("button#new-concept").button(),$("button#new-concept").on("click",(function(){let o=$("#concept-dialog-template").clone();o.attr("id","concept-dialog"),o.removeClass("concept-dialog");let e=o.find("#concept-form");e.attr("action","/_new_concept"),o.dialog({modal:!0,title:"New Concept",width:500,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),e.append(`<input type="hidden" name="idf_hex" value="${t.hex}" />`),e.append(`<input type="hidden" name="idf_var" value="${t.var}" />`),e.trigger("submit")},Cancel:function(){$(this).dialog("close")}},close:function(){$(this).remove()}})}))}$("mi").on("click",(function(){let o=sessionStorage.getItem("mi_id");null!=o&&$("#"+t(o)).removeAttr("style"),sessionStorage.mi_id=$(this).attr("id"),i($(this)),"true"==localStorage["option-limited-highlight"]&&(e.limited_highlight=!0),u()})),$(window).scrollTop(localStorage.scroll_top);let a=sessionStorage.mi_id;null!=a&&i($("#"+t(a)))})),$((function(){let e,n;$(document).on("mouseup",(function(i){e=i.pageX,n=i.pageY,$(".sog-menu").css("display","none");let[l,c,s]=function(){var t,o,e,n;let i;if(window.getSelection?i=window.getSelection():document.getSelection&&(i=document.getSelection()),null==i||"Range"!=i.type)return[void 0,void 0,void 0];let l=null===(t=null==i?void 0:i.anchorNode)||void 0===t?void 0:t.parentElement,a=null===(o=null==i?void 0:i.focusNode)||void 0===o?void 0:o.parentElement;if(null==l||null==a)return[void 0,void 0,void 0];if(0==$(l).parents(".main").length||0==$(a).parents(".main").length)return[void 0,void 0,void 0];let c,s,d,r,p=l.getBoundingClientRect(),u=a.getBoundingClientRect();return p.top<u.top||p.top==u.top&&p.left<=u.left?[c,s]=[l,a]:[c,s]=[a,l],"gd_word"==c.className?d=c.id:"gd_word"==(null===(e=c.nextElementSibling)||void 0===e?void 0:e.className)?d=c.nextElementSibling.id:console.warn("Invalid span for a source of grounding"),"gd_word"==s.className?r=s.id:"gd_word"==(null===(n=s.previousElementSibling)||void 0===n?void 0:n.className)?r=s.previousElementSibling.id:console.warn("Invalid span for a source of grounding"),[d,r,c]}();if(null==s)return;$(".sog-menu input[type=submit]").button();let d=sessionStorage.mi_id;null!=d&&null!=a(o($("#"+t(d))))&&$(".sog-menu").css({left:e,top:n-20}).fadeIn(200).css("display","flex");let r=`<p>Selected mi: <span style="font-family: monospace;">${d}</span></p>`;$(".sog-add-menu-info").html(r),$(".sog-menu .sog-add").off("click"),$(".sog-menu .sog-add").on("click",(function(){$(".sog-menu").css("display","none");let t={mi_id:d,start_id:l,stop_id:c};localStorage.scroll_top=$(window).scrollTop(),$.when($.post("/_add_sog",t)).done((function(){location.reload()})).fail((function(){console.error("Failed to POST _add_sog!")}))})),null!=(null==s?void 0:s.getAttribute("data-sog-mi"))?$(".sog-mod-menu").css("display","inherit"):$(".sog-mod-menu").css("display","none");let p=s.getAttribute("data-sog-mi"),u=Number(s.getAttribute("data-sog-type")),g=s.getAttribute("data-sog-start"),f=s.getAttribute("data-sog-stop"),m="unknown";0==u?m="declaration":1==u?m="definition":2==u&&(m="others");let h=`<p>SoG for <span style="font-family: monospace;">${p}</span><br/>Type: ${m}</p>`;$(".sog-mod-menu-info").html(h),$(".sog-menu .sog-type").off("click"),$(".sog-menu .sog-type").on("click",(function(){if($(".sog-menu").css("display","none"),null==s)return;let t=$("#sog-type-dialog-template").clone();t.attr("id","sog-type-dialog"),t.removeClass("sog-type-dialog");let o=t.find("#sog-type-form");o.attr("action","/_change_sog_type"),t.find(`input[value="${u}"]`).prop("checked",!0),t.dialog({modal:!0,title:"Change SoG Type",width:200,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),o.append(`<input type="hidden" name="mi_id" value="${p}" />`),o.append(`<input type="hidden" name="start_id" value="${g}" />`),o.append(`<input type="hidden" name="stop_id" value="${f}" />`),o.trigger("submit")},Cancel:function(){$(this).dialog("close")}},close:function(){$(this).remove()}})})),$(".sog-menu .sog-del").off("click"),$(".sog-menu .sog-del").on("click",(function(){if($(".sog-menu").css("display","none"),null==s)return;let t={mi_id:s.getAttribute("data-sog-mi"),start_id:s.getAttribute("data-sog-start"),stop_id:s.getAttribute("data-sog-stop")};localStorage.scroll_top=$(window).scrollTop(),$.when($.post("/_delete_sog",t)).done((function(){location.reload()})).fail((function(){console.error("Failed to POST _delete_sog!")}))}))}))})),$((function(){$("mi").each((function(){!function(t){let e=c(o(t));null==t.data("math-concept")&&null!=e&&t.attr("mathbackground","#D3D3D3")}($(this))}))}));for(let t=1;t<10;t++)$(document).on("keydown",(function(o){var e;$("#concept-dialog")[0]||o.key==t.toString(10)&&(e=t,$("#c"+(e-1))[0]&&($('input[name="concept"]').prop("checked",!1),$("#c"+(e-1)).prop("checked",!0)))}));$(document).on("keydown",(function(t){"Enter"==t.key&&($("#concept-dialog")[0]||$("#assign-concept").trigger("click"))})),$((function(){0!=$("#error-message").text().length&&$("#error-dialog").dialog({dialogClass:"error-dialog",modal:!0,title:"Error",buttons:{OK:function(){$(this).dialog("close")}}})})),$((function(){$(window).scrollTop(localStorage.scroll_top)}))})();